{% extends "core/base.html" %}
{% load static %}

{% block meta_title %}{{ APP_NAME }} · {{ page_title }}{% endblock %}
{% block meta_description %}Probador de envíos de mensajes para herramientas internas.{% endblock %}

{% block content %}
<section class="section is-title-bar">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <ul>
          <li>Admin</li>
          <li>Contactos</li>
        </ul>
      </div>
    </div>
    <!-- <div class="level-right">
      <div class="level-item">
        <div class="buttons is-right">
          <a href="#" target="_blank" class="button is-primary">
            <span class="icon"><i class="mdi mdi-github-circle"></i></span>
            <span>GitHub</span>
          </a>
        </div>
      </div>
    </div> -->
  </div>
</section>
<section class="hero is-hero-bar">
  <div class="hero-body">
    <div class="level">
      <div class="level-left">
        <div class="level-item"><h1 class="title">
          Contactos
        </h1></div>
      </div>
    </div>
  </div>
</section>

<section class="hero is-light is-small">
  <div class="hero-body">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <p class="subtitle">
            <span class="icon"><i class="mdi mdi-account-multiple"></i></span>
            <div class="ml-2">
            {% include "core/_contacts_group_selector.html" with groups=groups selected_group=selected_group select_id="groupSelector" %}
            </div>
          </p>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <div class="buttons is  right">
            <!-- <a href="#" class="button is-primary">
              <span class="icon"><i class="mdi mdi-plus"></i></span>
              <span>Nuevo Contacto</span>
            </a> -->
            <a href="#" class="button is-primary" onclick="openModalWithForm(null, 'new-group-modal')">
              <span class="icon"><i class="mdi mdi-plus"></i></span>
              <span>Nuevo Grupo</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MAIN CONTENT -->
<section class="section is-main-section">
  <!-- LISTA DE CONTACTOS -->
  <div class="card has-table has-mobile-sort-spaced">
    <header class="card-header">
      <div class="card-header-title">
        <span class="icon"><i class="mdi mdi-account-multiple"></i></span>
        {% if selected_group %}
          Contactos del grupo: {{ selected_group.name }}
        {% else %}
          Selecciona un grupo para ver sus contactos
        {% endif %}
      </div>
      <!-- <a href="#" class="card-header-icon">
        <span class="icon"><i class="mdi mdi-reload"></i></span>
      </a> -->
      <a href="#" class="card-header-icon has-dropdown">
        <b>submenu</b>
        <span class="icon"><i class="mdi mdi-chevron-down"></i></span>
      </a>
    </header>
    <div class="card-content">
      <div class="b-table has-pagination">
        <div class="table-wrapper has-mobile-cards">
          <table class="table is-fullwidth is-striped is-hoverable is-sortable is-fullwidth">
            <thead>
            <tr>
              <th>Nombre</th>
              <th>Teléfono</th>
              <th>Texto 1</th>
              <th>Texto 2</th>
              <th>Texto 3</th>
              <th class="level-right">Activo</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            {% if not contacts %}
            <tr>
              <td colspan="7" class="empty-table">
                <div>
                  <span class="icon"><i class="mdi mdi-account-multiple"></i></span>
                  Selecciona un grupo para ver sus contactos
                </div>
              </td>
            </tr>
            {% endif %}

            {% for contact in contacts %}
            <tr>
              <td>{{ contact.name }}</td>
              <td>{{ contact.phone }}</td>
              <td>{{ contact.text_1 }}</td>
              <td>{{ contact.text_2 }}</td>
              <td>{{ contact.text_3 }}</td>
              <td>
                <div class="buttons is-right">
                  <form class="toggle-contact-form" data-url="{% url 'toggle_contact' contact.pk %}">
                    {% csrf_token %}
                    <div class="field-body">
                      <div class="field">
                        <div class="control">
                          <label class="switch is-rounded is-small">
                            <input type="checkbox" {% if contact.active %}checked{% endif %}>
                            <span class="check"></span>
                            <!-- <span class="control-label">{% if contact.active %}Activo{% else %}Inactivo{% endif %}</span> -->
                          </label>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                </td>
                <td>
                <div class="buttons is-right">
                  <form method="post" action="{% url 'contact_delete' contact.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="button" title="Borrar" class="button is-small is-danger" onclick="openModalWithForm(this.form, 'confirm-delete-modal')">
                      <span class="icon is-small"><i class="mdi mdi-delete"></i></span>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
              <th colspan="7" class="has-text-right">
                {% if contacts %}
                 cantidad: {{ contacts|length }}
                {% else %}
                 cantidad: 0
                {% endif %}
              </th>
            </tr>
            </tfoot>
          </table>
        </div>

        <!-- PAGINADOR
        <div class="notification">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <div class="buttons has-addons">
                  <button type="button" class="button is-active">1</button>
                  <button type="button" class="button">2</button>
                  <button type="button" class="button">3</button>
                </div>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <small>Page 1 of 3</small>
              </div>
            </div>
          </div>
        </div> -->
      </div>
    </div>
  </div>

  <hr>

  <!-- Errores de carga de contactos -->
  {% if errors %}
  <div class="notification is-danger">
      <button class="delete" onclick="this.parentElement.style.display='none';"></button>
      <ul>
      {% for error in errors %}
          <li>{{ error }}</li>
      {% endfor %}
      </ul>
  </div>
  {% endif %}
  

  <div class="tile is-ancestor">
    <div class="tile is-parent">
      <div class="card tile is-child">
        <header class="card-header">
          <p class="card-header-title">
            <span class="icon"><i class="mdi mdi-upload default"></i></span>
            Importar Contactos en CSV al grupo&nbsp;
            {% if not selected_group %}
              <span class="has-text-danger">Selecciona un grupo primero</span>
            {% else %}
              <span class="has-text-success">{{ selected_group.name }}</span>
            {% endif %}
          </p>
        </header>
        <div class="card-content">
          <p class="subtitle is-5">1. Seleccioná un archivo con contactos:</p>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in form_csv %}
            {% endfor %}
            <div class="field is-horizontal">
              <div class="field-label is-normal"><label class="label">{{ form_csv.file.label }}</label></div>
              <div class="field-body">
                <div class="field">
                  <div class="field file">
                    <label class="upload control">
                      {{ form_csv.file }}
                      <a class="button is-primary">
                        <span class="icon"><i class="mdi mdi-magnify-scan default"></i></span>
                        <span>Elegir archivo</span>
                      </a>
                      <span class="file-name" id="file-name">Ninguno</span>
                    </label>
                  </div>
                </div>
              </div>
              {% if form_csv.file.errors %}
                <p class="help is-danger">{{ form_csv.file.errors|striptags }}</p>
              {% endif %}
            </div>
            <hr>
            <p class="subtitle is-5">2. Verifica los contactos a cargar:</p>
            <div class="field">
              <div class="field">
                <div id="csv-preview" class="table-container scrollable-table"></div>
              </div>
            </div>
            <hr>
            <p class="subtitle is-5">3. Carga el archivo</p>
            <div class="field is-horizontal">
              <div class="field-label is-normal"></div>
              <div class="field-body">
                <div class="field">
                  <div class="control">
                    <button type="submit" class="button is-primary" id="uploadBtn" disabled>
                      <i class="mdi mdi-upload"></i>
                      <span class="ml-2">Cargar CSV</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- Carga Contactos Texto -->
    <div class="tile is-parent">
      <div class="card tile is-child">
        <header class="card-header">
          <p class="card-header-title">
            <span class="icon"><i class="mdi mdi-account default"></i></span>
            Cargar Contactos Manualmente
          </p>
        </header>
        <div class="card-content">
          <form method="post">
            {% csrf_token %}
            <div class="field">
              <div class="field-label level-left">
                <label class="label">{{ form_text.raw_contacts.label }}</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <div class="control">
                    {{ form_text.raw_contacts }}
                  </div>
                </div>
              </div>
            </div>
            <hr>
            <div class="field is-horizontal">
              
              <div class="field-body">
                <div class="field">
                  <div class="control">
                    <button type="submit" class="button is-primary">Cargar texto</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de confirmación para borrar contacto -->
{% include "core/_confirm_modal.html" with modal_id="confirm-delete-modal" title="¿Confirmar borrado?" body="¿Seguro que querés borrar este contacto?" confirm_text="Sí, borrar" %}
{% include "core/_new_group_modal.html" %}
<!---->

{% endblock %}

{% block extra_scripts %}
<script>
  const input = document.querySelector('input[type="file"]');
  const fileName = document.getElementById('file-name');
  const preview = document.getElementById('csv-preview');
  const uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = true;

  input.addEventListener('change', () => {
    const file = input.files[0];
    fileName.textContent = file ? file.name : 'Ninguno';
    preview.innerHTML = '';

    if (file && file.type === 'text/csv') {
      uploadBtn.disabled = false;
      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split('\n').filter(Boolean);
        const table = document.createElement('table');
        table.className = 'table is-striped is-hoverable is-fullwidth scrollable-table csv-preview-table';
        const headerRow = document.createElement('thead');
        headerRow.innerHTML = '<tr><th>Nombre</th><th>Teléfono</th><th>Activo</th><th>Texto 1</th><th>Texto 2</th><th>Texto 3</th></tr>';
        table.appendChild(headerRow);

        lines.forEach((line, index) => {
          const row = document.createElement('tr');
          line.split(',').forEach(cell => {
            const el = document.createElement(index === -1 ? 'th' : 'td');
            el.textContent = cell.trim();
            row.appendChild(el);
          });
          table.appendChild(row);
        });

        preview.appendChild(table);
      };
      reader.readAsText(file);
    } else if (file) {
      preview.innerHTML = '<p class="help is-danger">El archivo debe ser CSV</p>';
      file.value = '';
      fileName.textContent = 'Ninguno';
    }
  });

  /* Toggle contact active state with AJAX */
  document.querySelectorAll('.toggle-contact-form').forEach(form => {
    const checkbox = form.querySelector('input[type="checkbox"]');
    // const label = form.querySelector('.control-label');
    const url = form.dataset.url;
    const csrf = form.querySelector('[name="csrfmiddlewaretoken"]').value;

    checkbox.addEventListener('change', async () => {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf,
          'X-Requested-With': 'XMLHttpRequest',
        },
      });

      if (res.ok) {
        const data = await res.json();
        // label.textContent = data.active ? 'Activo' : 'Inactivo';
      } else {
        checkbox.checked = !checkbox.checked; // revertir si falla
      }
    });
  });

  // Select customers group
  setupSelectParamUpdater("groupSelector", "group");
</script>
{% endblock %}

{% block extra_styles %}
<style>
td.empty-table {
  background-color: #fff;
  border: 1px solid #f9f9f9;
  border-radius: 4px;
}
td.empty-table:hover {
  background-color: #fff;
}
.empty-table div {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 260px;
  color: #CCC;
  font-size: 1.2em;
  text-align: center;
}
#csv-preview {
  max-height: 300px;
  overflow-y: auto;
}
</style>
{% endblock %}