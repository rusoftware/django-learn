{% extends "core/base.html" %}

{% block meta_title %}{{ APP_NAME }} Â· ðŸ§ª Herramientas de prueba{% endblock %}
{% block meta_description %}Probador de envÃ­os de mensajes para herramientas internas.{% endblock %}

{% block content %}
<section class="section is-title-bar">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <ul>
          <li>Admin</li>
          <li>Tests</li>
        </ul>
      </div>
    </div>
  </div>
</section>
<section class="hero is-hero-bar">
  <div class="hero-body">
    <div class="level">
      <div class="level-left">
        <div class="level-item"><h1 class="title">
          Testing utilities
        </h1></div>
      </div>
    </div>
  </div>
</section>

<!-- MAIN CONTENT -->
<section class="section is-main-section">
  <div class="card">
    <header class="card-header">
      <p class="card-header-title">
        <span class="icon"><i class="mdi mdi-test-tube"></i></span>
        Herramientas de prueba de envÃ­o
      </p>
    </header>
    <div class="card-content">
      <div class="field">
        <label class="label">Seleccionar instancia:</label>
        <div class="control">
          <div class="select">
            <select id="instance-select">
              {% for inst in instances %}
                <option value="{{ inst.instance_name }}">{{ inst.instance_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">Seleccionar contacto:</label>
        <div class="control">
          <div class="select">
            <select id="contact-select">
              {% for contact in contacts %}
                <option value="{{ contact.id }}">{{ contact.name }} ({{ contact.phone }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <button class="button is-primary" onclick="sendTest('text')">Enviar mensaje de texto</button>
      <button class="button is-primary" onclick="sendTest('media')">Enviar mensaje con media</button>
      <hr>
      <div id="test-result" style="margin-top: 20px; font-family: monospace;"></div>
    </div>
  </div>
</section>

<!--------------------------------->

{% endblock %}

{% block extra_scripts %}
<script>
function sendTest(type) {
    const instance = document.getElementById('instance-select').value;
    const contact = document.getElementById('contact-select').value;  
    const url = type === 'text' ? "{% url 'test_send_text' %}" : "{% url 'test_send_media' %}";
    const output = document.getElementById('test-result');

    output.textContent = "Enviando...";

    fetch(url + `?instance=${encodeURIComponent(instance)}&contact_id=${encodeURIComponent(contact)}`)
        .then(async response => {
            if (!response.ok) {
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Error desconocido");
                return data;
            }
            return response.json();
        })
        .then(data => {
        output.textContent = JSON.stringify(data, null, 2);
        })
        .catch(err => {
            output.textContent = "Error:\n" + err.message;
        });
}
</script>
{% endblock %}
