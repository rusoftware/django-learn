{% extends "core/base.html" %}
{% load static %}

{% block meta_title %}{{ APP_NAME }} ¬∑ üì¢ Campa√±as{% endblock %}
{% block meta_description %}Probador de env√≠os de mensajes para herramientas internas.{% endblock %}

{% block content %}
{% load custom_filters %}
<section class="section is-title-bar">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <ul>
          <li>Admin</li>
          <li>Campa√±as</li>
        </ul>
      </div>
    </div>
    <!-- <div class="level-right">
      <div class="level-item">
        <div class="buttons is-right">
          <a href="#" target="_blank" class="button is-primary">
            <span class="icon"><i class="mdi mdi-github-circle"></i></span>
            <span>GitHub</span>
          </a>
        </div>
      </div>
    </div> -->
  </div>
</section>
<section class="hero is-hero-bar">
  <div class="hero-body">
    <div class="level">
      <div class="level-left">
        <div class="level-item"><h1 class="title">
          Campa√±as
        </h1></div>
      </div>
    </div>
  </div>
</section>

<!-- MAIN CONTENT -->
<section class="section is-main-section">
  <div class="card has-table has-mobile-sort-spaced">
    <header class="card-header">
      <p class="card-header-title">
        <span class="icon"><i class="mdi mdi-bullhorn-outline"></i></span>
        Campa√±as
      </p>
    </header>
    <div class="card-content">
      <div class="b-table has-pagination">
        <div class="table-wrapper has-mobile-cards">
          <table class="table is-fullwidth is-striped is-hoverable is-sortable is-fullwidth">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Creada</th>
                <th class="has-text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for campaign in campaigns %}
                {% if campaign|is_campaign_editable %}
                  <tr>
                {% else %}
                  <tr class="has-text-grey">
                {% endif %}

                <td>{{ campaign.name }}</td>
                <td>{{ campaign.get_send_type_display }}</td>
                <td>{{ campaign.get_status_display }}</td>
                <td>{{ campaign.created_at|date:"Y-m-d H:i" }}</td>
                <td class="has-text-right">
                  {% if campaign|is_campaign_editable %}
                    <a href="{% url 'campaign_edit' campaign.pk %}#campaignForm" class="button is-small is-info" title="Editar">
                      <span class="icon is-small"><i class="mdi mdi-pencil"></i></span>
                    </a>

                    <form method="post" action="{% url 'campaign_delete' campaign.pk %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="button" title="Borrar" class="button is-small is-danger" onclick="openModalWithForm(this.form, 'confirm-delete-modal')">
                        <span class="icon is-small"><i class="mdi mdi-delete"></i></span>
                      </button>
                    </form>

                    <a href="{% url 'campaign_send' %}?campaign={{ campaign.pk }}" class="button is-small is-primary" title="Enviar">
                      <span class="icon is-small"><i class="mdi mdi-send"></i></span>
                    </a>
                  {% else %}
                    <span class="tag is-success is-light" style="margin-right: 4px;">
                      ‚úÖ {{ campaign.success_count|default:"0" }}
                    </span>/
                    <span class="tag is-danger is-light">
                      {{ campaign.error_count|default:"0" }} ‚ùå
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No hay campa√±as.</td></tr>
            {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="5" class="has-text-right">
                  total: {{ campaigns|length }}
                </th>
              </tr> 
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <hr>
  <!-- Agregar/Editar Campa√±a -->
  {% if form.non_field_errors %}
  <div class="notification is-danger" id="errorMessage">
      <button class="delete" onclick="this.parentElement.style.display='none';"></button>
      <ul>
      {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
      {% endfor %}
      </ul>
  </div>
  {% endif %}

  <div class="card" id="campaignForm">
    <header class="card-header">
      <p class="card-header-title">
        {% if editing %}
          <span class="icon"><i class="mdi mdi-pencil-outline"></i></span>
          Editando campa√±a: {{ campaign_editing.name }}
        {% else %}
          <span class="icon"><i class="mdi mdi-plus"></i></span>
          Nueva Campa√±a de Whatsapp
        {% endif %}
      </p>
      <p class="card-header-icon">
        <img src="https://static.whatsapp.net/rsrc.php/yZ/r/JvsnINJ2CZv.svg" alt="WhatsApp" style="height: 22px;">
      </p>
    </header>
    <div class="card-content">
      <div class="columns is-centered">
        <div class="column is-three-quarters">

      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {% for field in form %}
          <div class="field is-horizontal">
            <div class="field-label is-normal">
              <label class="label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            </div>
            <div class="field-body">
              <div class="field">
                <div class="control">
                  {% if field.field.widget|classname == "Select" %}
                  <div class="select is-fullwidth">
                    {{ field }}
                  </div>
                  {% else %}
                    {{ field }}
                  {% endif %}
                </div>
                {% if field.errors %}
                  <p class="help is-danger">{{ field.errors|striptags }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
        
        <hr>
        
        <div class="field is-fullwidth">
          <div class="control">
            <button type="submit" class="button is-primary">{% if editing %}Guardar cambios{% else %}Crear campa√±a{% endif %}</button>
          </div>
        </div>
        {% if editing %}
          <a href="{% url 'campaign_list' %}" style="margin-left: 1em;">‚ùå Cancelar</a>
        {% endif %}
      </form>
      </div>
      <div class="column is-one-quarter">
        <!-- <div class="notification is-info">
          <p class="title is-4">¬øC√≥mo funciona?</p>
          <p class="subtitle is-6">Crea campa√±as para enviar mensajes a grupos de contactos.</p>
          <ul>
            <li>Selecciona un grupo de contactos.</li>
            <li>Revisa el contenido del mensaje.</li>
            <li>Env√≠a la campa√±a y revisa el progreso en tiempo real.</li>
          </ul>
        </div> -->
        <div id="campaignPreview">
          {% include "core/_whatsapp_preview.html" with campaign=campaign_editing mediatype=campaign_editing.mediatype mimetype=campaign_editing.mimetype %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MODAL -->
 {% include "core/_confirm_modal.html" with modal_id="confirm-delete-modal" title="¬øConfirmar borrado?" body="¬øSeguro que quer√©s borrar esta campa√±a?" confirm_text="S√≠, borrar" %}
<!-- END MODAL-->

{% endblock %}
{% block extra_scripts %}
<script>
  // Disable MEDIA fields if campaign type = TEXT
  document.addEventListener('DOMContentLoaded', function () {
    const sendTypeSelect = document.querySelector('#id_send_type');
    const mediaFileInput = document.querySelector('#id_media_file');
    const mediaUrlInput = document.querySelector('#id_media_url');
    const mediaFileName = document.querySelector('#id_filename');
    const mediaFields = [mediaFileInput, mediaUrlInput, mediaFileName];

    function toggleMediaFields() {
      if (sendTypeSelect.value === 'media') {
        mediaFields.forEach(field => {
          field.disabled = false;
        });
      } else {
        mediaFields.forEach(field => {
          field.disabled = true;
        });
      }
    }

    sendTypeSelect.addEventListener('change', toggleMediaFields);
    toggleMediaFields(); // Initial call to set the state
  });

  
  // Update campaign preview on form changes
  const mediaInput = document.getElementById('id_media_url');
  const msgInput = document.getElementById('id_message');
  const filenameInput = document.getElementById('id_filename');
  const campaignPreview = document.getElementById('campaignPreview');
  const msgCampaignPreview = campaignPreview.querySelector('.whatsapp-message');
  const mediaContainer = campaignPreview.querySelector('#mediaContainer');

  function getMediaType(url) {
    const cleanUrl = url.split('?')[0].split('#')[0];
    const extension = cleanUrl.split('.').pop().toLowerCase();

    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) return 'image';
    if (['mp4', 'webm', 'ogg'].includes(extension)) return 'video';
    if (['mp3', 'wav', 'ogg'].includes(extension)) return 'audio';

    // No es media directo, se deja como link enriquecido
    return null;
  }

  function updateFileNamePreview() {
    const link = document.getElementById('documentPreview');
    link.textContent = filenameInput.value.trim() || 'Archivo adjunto';
  }

  function updateMsgPreview() {
    const msg = msgInput.value.trim();
    msgCampaignPreview.innerHTML = msg.replace(/\n/g, '<br>');
  }

  function updateMediaPreview() {
    const url = mediaInput.value.trim();
    const filename = filenameInput.value.trim() || 'Archivo adjunto';

    // Limpiar media anterior
    mediaContainer.innerHTML = '';
    updateMsgPreview();

    if (!url) return;

    const type = getMediaType(url);
    let mediaElement;

    if (type === 'image') {
      mediaElement = document.createElement('figure');
      mediaElement.className = 'image mb-2';
      const img = document.createElement('img');
      img.id = 'mediaPreview';
      img.src = url;
      img.style.borderRadius = '8px';
      mediaElement.appendChild(img);
    } else if (type === 'video') {
      mediaElement = document.createElement('video');
      mediaElement.style.borderRadius = '4px';
      mediaElement.style.maxWidth = '100%';
      mediaElement.controls = true;
      const source = document.createElement('source');
      source.src = url;
      source.type = 'video/mp4';
      mediaElement.appendChild(source);
    } else if (type === 'audio') {
      mediaElement = document.createElement('audio');
      mediaElement.controls = true;
      const source = document.createElement('source');
      source.src = url;
      source.type = 'audio/mpeg';
      mediaElement.appendChild(source);
    } else {
      mediaElement = document.createElement('p');
      const link = document.createElement('a');
      link.id = 'documentPreview';
      link.href = mediaInput.value.trim();
      link.textContent = filename || 'Archivo adjunto';
      mediaElement.appendChild(link);
    }

    mediaContainer.appendChild(mediaElement);
  }

  mediaInput.addEventListener('input', updateMediaPreview);
  filenameInput.addEventListener('input', updateFileNamePreview);
  msgInput.addEventListener('input', updateMsgPreview);

</script>
{% endblock %}