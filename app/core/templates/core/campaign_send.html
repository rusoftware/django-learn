{% extends "core/base.html" %}
{% load static %}

{% block meta_title %}{{ APP_NAME }} ¬∑ üöÄ Enviar campa√±a {{ campaign.name }}{% endblock %}
{% block meta_description %}Seleccion√° grupo e instancias para enviar la campa√±a {{ campaign.name }}.{% endblock %}

{% block content %}
<section class="section is-title-bar">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <ul>
          <li>Admin</li>
          <li>Enviar Campa√±a</li>
        </ul>
      </div>
    </div>
  </div>
</section>
<section class="hero is-hero-bar">
  <div class="hero-body" style="background-color: aquamarine;">
    <div class="level">
      <div class="level-left">
        <div class="level-item"><h1 class="title">
          <span class="has-text-weight-normal" style="font-size: .8em;">Campa√±a Seleccionada: </span>{{ campaign.name }}
        </h1></div>
      </div>
      <div class="level-right" style="display: block;">
        <div class="level-item">
          <a href="{% url 'campaign_list' %}">‚Üê Volver a campa√±as</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MAIN CONTENT -->
<section class="section is-main-section">
  <!-- step 1 -->
  <div class="card">
    <header class="card-header">
      <p class="card-header-title">
        Configuraci√≥n y env√≠a tu campa√±a
      </p>
      <p class="card-header-icon">
        <img src="https://static.whatsapp.net/rsrc.php/yZ/r/JvsnINJ2CZv.svg" alt="WhatsApp" style="height: 22px;">
      </p>
    </header>
    <div class="card-content">
      <div class="columns is-centered">
        <!-- Configuraci√≥n del envio} -->
        <div class="column is-one-quarter has-background-white-bis settings">
          <p class="has-text-weight-bold">Seleccion√° Grupo Destinatario:</p>
          
          {% include "core/_contacts_group_selector.html" with groups=groups selected_group=selected_group select_id="groupSelector" %}

          <!-- <div class="select is-fullwidth">
            <select name="group" id="groupSelector">
              {% for group in groups %}
              <option value="{{ group.id }}" {% if group.id == selected_group.id %}selected{% endif %}>{{ group.name }}</option>
              {% endfor %}
            </select>
          </div> -->
          
          <hr>
          <p class="has-text-weight-bold">Contactos Seleccionados:</p>
          <div class="facepile">
            {% for contact in contacts|slice:":3" %}
              <div class="avatar-initial" title="{{ contact.name }} ({{ contact.phone }})">
                {{ contact.name|slice:":1"|upper }}
              </div>
            {% endfor %}

            {% if contacts|length > 3 %}
              <a title="ver todos los destinatarios" onclick="document.getElementById('recipient-modal').classList.add('is-active')">
                +{{ contacts|length|add:"-3" }} m√°s
              </a>
            {% endif %}
          </div>

          <hr>
          
          <p class="has-text-weight-bold">
            Instancias que se Utilizaran:
            <span class="is-small" style="float: right;">
              <a href="{% url 'instances_list' %}" class="is-small">cambiar</a>
            </span>
          </p>
          {% if instances %}
          <table class="table is-fullwidth is-small is-striped">
            <thead>
              <tr>
                <th>Instancia</th>
                <th class="has-text-right">Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for instance in instances %}
              <tr data-instance="{{ instance.instance_name }}">
                <td title="{{ instance.instance_name }}">{{ instance.description }}</td>
                <td class="status-tag has-text-right">
                  <span class="tag is-info">wait...</span>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
          {% else %}
            <p>No hay instancias disponibles para enviar mensajes.</p>
          {% endif %}
          
          <hr>
          <p>Tipo de env√≠o: <strong>{{ campaign.send_type }}</strong></p>
        </div>

        <!-- Preview del mensaje -->
        <div class="column is-one-quarter has-background-white-ter">
          <p class="has-text-weight-bold">Preview del Mensaje:</p>
          {% include "core/_whatsapp_preview.html" with campaign=campaign mediatype=mediatype mimetype=mimetype %}
        </div>

        <!-- Instrucciones -->
        <div class="column is-two-quarter has-background-grey-soft">
          <div class="notification is-info" id="instructionsPanel">
            <p class="title is-4">¬øC√≥mo funciona?</p>
            <p class="subtitle is-6">Crea campa√±as para enviar mensajes a grupos de contactos.</p>
            <ul>
              <li>1. Selecciona un grupo de contactos y revisa la configuraci√≥n.</li>
              <li>2. Revisa el contenido del mensaje.</li>
              <li>3. Env√≠a la campa√±a y comprueba el progreso en tiempo real.</li>
            </ul>
          </div>

          <!-- Estado del env√≠o -->
          <div id="sendStatusPanel" class="box" style="display: none;">
            <div class="columns is-fullwidth">
              <div class="column is-three-quarters">
                <h4 class="title is-6">Estado del env√≠o</h4>
              </div>
              <div class="column is-one-quarter has-text-right">
                <p id="campaignCounter" class="mb-3">Enviando 0 / {{ contacts|length }}...</p>
              </div>
            </div>

            <!-- Progreso general -->
            <progress id="campaignProgressBar" class="progress is-success" value="0" max="100">
              0%
            </progress>

            <!-- Detalle por contacto -->
            <div class="table-container scrollable-table status-table">
            <table class="table is-fullwidth is-size-7 is-striped is-hoverable">
              <thead>
                <tr>
                  <th></th>
                  <th>Usuario</th>
                  <th>Tel√©fono</th>
                  <th>Instancia</th>
                  <th>Resultado</th>
                </tr>
              </thead>
              <tbody id="campaignResults">
                <!-- JS ir√° llenando esto din√°micamente -->
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <div class="card-footer-item">
        <button id="sendBtn" class="button is-primary">Enviar campa√±a</button>
      </div>
    </div>
  </div>
</section>


<!-- Modal for recipients -->
<div class="modal" id="recipient-modal">
  <div class="modal-background" onclick="closeModal()"></div>
  <div class="modal-card" style="width: 600px; max-height: 80vh;">
    <header class="modal-card-head">
      <p class="modal-card-title">Destinatarios del grupo: <b>{{ selected_group.name }}</b></p>
      <button class="delete" aria-label="close" onclick="closeModal()"></button>
    </header>

    <section class="modal-card-body" style="overflow-y: auto;">
      {% if contacts %}
      <ul>
        {% for contact in contacts %}
        <li><b>{{ contact.name }}</b> - {{ contact.phone }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No hay contactos en este grupo.</p>
      {% endif %}
    </section>

    <footer class="modal-card-foot">
      <button class="button is-success" onclick="closeModal()">Cerrar</button>
    </footer>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}

{% if testmode %}
  <script src="{% static 'js/mock_event_source.js' %}"></script>
{% endif %}

<script>
  // Configurar el EventSource para recibir mensajes de progreso
  const USE_MOCK_EVENTSOURCE = "{{ testmode|yesno:'true,false' }}" === "true";
  
  // Mostrar la hora actual en la previsualizaci√≥n
  document.getElementById('time').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  // Configurar el bot√≥n de env√≠o y el EventSource
  const btn = document.getElementById('sendBtn');
  const instructionsPanel = document.getElementById('instructionsPanel');
  const sendStatusPanel = document.getElementById('sendStatusPanel');
  const counter = document.getElementById('campaignCounter');
  const progressBar = document.getElementById('campaignProgressBar');
  const resultsBody = document.getElementById('campaignResults');

  btn.addEventListener('click', () => {
    btn.disabled = true;
    sendStatusPanel.style.display = 'block';
    instructionsPanel.style.display = 'none';
    resultsBody.innerHTML = '';
    counter.textContent = 'Iniciando env√≠o de mensajes...';

    const campaignId = "{{ campaign.id }}";
    const groupId = document.getElementById('groupSelector').value;

    // Usar MockEventSource si est√° habilitado modo TEST, o EventSource normal
    const eventSource = USE_MOCK_EVENTSOURCE
      ? new MockEventSource('mock')
      : new EventSource(`{% url 'send_messages' %}?campaign=${campaignId}&group=${groupId}`);

    eventSource.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const row = document.createElement('tr');

      const badge = document.createElement('span');
      badge.className = 'tag is-success';
      badge.textContent = data.status;

      if (data.status === 'error') {
        badge.className = 'tag is-danger';
        badge.title += ` - ERROR: ${data.error_message}`;
      }

      row.innerHTML = `
        <td>${data.current}/${data.total}</td>
        <td>${data.contact_name}</td>
        <td>${data.contact_phone}</td>
        <td>${data.instance_name}</td>
        <td>${badge.outerHTML}</td>
      `;

      counter.textContent = `Enviando ${data.current} / ${data.total}...`;
      progressBar.value = (data.current / data.total) * 100;
      progressBar.textContent = `${Math.round(progressBar.value)}%`;

      
      resultsBody.appendChild(row);

      if (data.current === data.total) {
        counter.textContent = 'Env√≠o completado.';
        eventSource.close();
        btn.disabled = false;
      }
    };

    eventSource.onerror = function() {
      progress.querySelector('p').textContent = 'Error en el env√≠o o conexi√≥n perdida.';
      eventSource.close();
      btn.disabled = false;
    };
  });

  // Handle group selection change
  setupSelectParamUpdater("groupSelector", "group");

  // Close modal function
  function closeModal() {
    document.getElementById('recipient-modal').classList.remove('is-active');
  }

  // Update instance statuses
  const rows = document.querySelectorAll('tr[data-instance]');

  const fetches = Array.from(rows).map(row => {
    const instanceName = row.dataset.instance;
    const statusCell = row.querySelector('.status-tag');

    return fetch(`/check-instance-status/${instanceName}/`)
      .then(res => res.json())
      .then(data => {
        const state = data?.instance?.state || 'unknown';
        let html = '';
        if (state === 'open') {
          html = `<span class="tag is-success">Conectada</span>`;
        } else if (state === 'close') {
          html = `<span class="tag is-danger">Desconectada</span>`;
        } else {
          html = `<span class="tag is-warning">${state}</span>`;
        }
        statusCell.innerHTML = html;
      })
      .catch(() => {
        statusCell.innerHTML = `<span class="tag is-warning">error</span>`;
      });
  });

</script>
{% endblock %}

{% block extra_styles %}
<style>
  .facepile {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    flex-wrap: wrap;
  }

  .avatar-initial {
    background-color: #00d1b2;
    color: white;
    font-weight: bold;
    border-radius: 9999px;
    width: 32px;
    height: 32px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9rem;
  }

  .facepile .avatar-initial:nth-child(1) {
    background-color: hsl(204, 86%, 53%);
  }
  .facepile .avatar-initial:nth-child(2) {
    background-color: hsl(217, 71%, 53%);
    margin-left: -14px !important;
  }
  .facepile .avatar-initial:nth-child(3) {
    background-color: hsl(171, 100%, 41%);
    margin-left: -14px !important;
  }

  .column.is-one-quarter.settings {
    min-height: 504px;
  }

  .scrollable-table.status-table {
    max-height: 340px;
  }

</style>
{% endblock %}